<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>Enhanced C#: Loyc.Threading.ThreadLocalVariable&lt; T &gt; Class Template Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Enhanced C#
   </div>
   <div id="projectbrief">Language of your choice: library documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<h1>Documentation moved to <a href="http://ecsharp.net/doc/code">ecsharp.net</a></h1>
<small>GitHub doesn't support HTTP redirects, so you'll be redirected in 3 seconds.</small>
<br/><br/>
<script>
setTimeout(function() {
	if (window.location.href.indexOf('http://loyc.net') == 0) {
	  window.location.href = 'http://ecsharp.net' + window.location.href.substr('http://loyc.net'.length);
	}
}, 3000);
</script>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Events</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespaceLoyc.html">Loyc</a></li><li class="navelem"><a class="el" href="namespaceLoyc_1_1Threading.html">Threading</a></li><li class="navelem"><a class="el" href="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4.html">ThreadLocalVariable< T ></a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#properties">Properties</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-attribs">Protected fields</a> &#124;
<a href="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">Loyc.Threading.ThreadLocalVariable&lt; T &gt; Class Template Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Provides access to a thread-local variable through a dictionary that maps thread IDs to values. 
 <a href="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4.html#details">More...</a></p>
<hr/><b>Source file</b>:<ul>
<li><a href='https://github.com/qwertie/ecsharp/tree/master/Core/Loyc.Essentials/Utilities/ThreadEx.cs'>/Core/Loyc.Essentials/Utilities/ThreadEx.cs</a></li>
</ul>
<div class="dynheader">
Inheritance diagram for Loyc.Threading.ThreadLocalVariable&lt; T &gt;:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4.png" usemap="#Loyc.Threading.ThreadLocalVariable&lt; T &gt;_map" alt=""/>
  <map id="Loyc.Threading.ThreadLocalVariable&lt; T &gt;_map" name="Loyc.Threading.ThreadLocalVariable&lt; T &gt;_map">
<area href="classLoyc_1_1Threading_1_1ThreadLocalVariableBase.html" title="When used with ThreadEx, implementing this base class allows you to be notified when a child thread i..." alt="Loyc.Threading.ThreadLocalVariableBase" shape="rect" coords="0,0,255,24"/>
</map>
 </div></div>
<a name="details" id="details"></a><h2 class="groupheader">Remarks</h2>
<div class="textblock"><p>Provides access to a thread-local variable through a dictionary that maps thread IDs to values.</p>
<dl class="tparams"><dt>Template Parameters</dt><dd>
  <table class="tparams">
    <tr><td class="paramname">T</td><td>Type of variable to wrap</td></tr>
  </table>
  </dd>
</dl>
<p>Note: this was written before .NET 4 (which has ThreadLocal{T}). Unlike ThreadLocal{T}, this class supports propagation from parent to child threads when used with <a class="el" href="classLoyc_1_1Threading_1_1ThreadEx.html" title="Creates and controls a thread, and fills in a gap in the .NET framework by propagating thread-local v...">ThreadEx</a>. </p>
<p>This class exists to solve two problems. First, the [ThreadStatic] attribute is not supported in the .NET Compact Framework. Second, and more importantly, .NET does not propagate thread-local variables when creating new threads, which is a huge problem if you want to implement the <a href="http://loyc-etc.blogspot.com/2010/08/pervasive-services-and-di.html">Ambient Service Pattern</a>. This class copies the T value from a parent thread to a child thread, but because .NET provides no way to hook into thread creation, it only works if you use <a class="el" href="classLoyc_1_1Threading_1_1ThreadEx.html" title="Creates and controls a thread, and fills in a gap in the .NET framework by propagating thread-local v...">ThreadEx</a> instead of standard threads. </p>
<p>ThreadLocalVariable implements thread-local variables using a dictionary that maps thread IDs to values. </p>
<p>Variables of this type are typically static and they must NOT be marked with the [ThreadStatic] attribute. </p>
<p>ThreadLocalVariable(of T) is less convenient than the [ThreadStatic] attribute, but ThreadLocalVariable works with <a class="el" href="classLoyc_1_1Threading_1_1ThreadEx.html" title="Creates and controls a thread, and fills in a gap in the .NET framework by propagating thread-local v...">ThreadEx</a> to propagate the value of the variable from parent threads to child threads, and you can install a propagator function to customize the way the variable is copied (e.g. in case you need a deep copy). </p>
<p>Despite my optimizations, ThreadLocalVariable is just over half as fast as a ThreadStatic variable in CLR 2.0, in a test with no thread contention. Access to the dictionary accounts for almost half of the execution time; try-finally (needed in case of asyncronous exceptions) blocks use up 11%; calling Thread.CurrentThread.ManagedThreadId takes about 9%; and the rest, I presume, is used up by the <a class="el" href="structLoyc_1_1Threading_1_1TinyReaderWriterLock.html" title="A fast, tiny 4-byte lock to support multiple readers or a single writer. Designed for low-contention...">TinyReaderWriterLock</a>. </p>
<p>TODO: consider switching from TinyReaderWriterLock+Dictionary to ConcurrentDictionary which has fine-grained locking (.NET 4 only). </p>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="properties"></a>
Properties</h2></td></tr>
<tr class="memitem:a90dd215de2d87d643432e6db9e7cb66c"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a90dd215de2d87d643432e6db9e7cb66c"></a>
bool&#160;</td><td class="memItemRight" valign="bottom"><b>HasValue</b><code> [get]</code></td></tr>
<tr class="separator:a90dd215de2d87d643432e6db9e7cb66c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa9a110d48f2270d2981c74669795f437"><td class="memItemLeft" align="right" valign="top">T&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4.html#aa9a110d48f2270d2981c74669795f437">Value</a><code> [get, set]</code></td></tr>
<tr class="memdesc:aa9a110d48f2270d2981c74669795f437"><td class="mdescLeft">&#160;</td><td class="mdescRight">Value of the thread-local variable. <a href="#aa9a110d48f2270d2981c74669795f437">More...</a><br /></td></tr>
<tr class="separator:aa9a110d48f2270d2981c74669795f437"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6c1e736aae51e5b1dc50d4fbde1b650f"><td class="memItemLeft" align="right" valign="top">T&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4.html#a6c1e736aae51e5b1dc50d4fbde1b650f">FallbackValue</a><code> [get, set]</code></td></tr>
<tr class="memdesc:a6c1e736aae51e5b1dc50d4fbde1b650f"><td class="mdescLeft">&#160;</td><td class="mdescRight">When a thread is not created using <a class="el" href="classLoyc_1_1Threading_1_1ThreadEx.html" title="Creates and controls a thread, and fills in a gap in the .NET framework by propagating thread-local v...">ThreadEx</a>, the value of your ThreadLocalVariable fails to propagate from the parent thread to the child thread. In that case, Value takes on the value of FallbackValue the first time it is called.  <a href="#a6c1e736aae51e5b1dc50d4fbde1b650f">More...</a><br /></td></tr>
<tr class="separator:a6c1e736aae51e5b1dc50d4fbde1b650f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:afa04386ff8e3a25c02f0b7e030a3a0a0"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="afa04386ff8e3a25c02f0b7e030a3a0a0"></a>
delegate TResult&#160;</td><td class="memItemRight" valign="bottom"><b>Func&lt; TArg0, TResult &gt;</b> (TArg0 arg0)</td></tr>
<tr class="separator:afa04386ff8e3a25c02f0b7e030a3a0a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa940e51dd31efe3dfe151cd46b4a148a"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4.html#aa940e51dd31efe3dfe151cd46b4a148a">ThreadLocalVariable</a> (T initialValue)</td></tr>
<tr class="memdesc:aa940e51dd31efe3dfe151cd46b4a148a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Constructs a ThreadLocalVariable. <a href="#aa940e51dd31efe3dfe151cd46b4a148a">More...</a><br /></td></tr>
<tr class="separator:aa940e51dd31efe3dfe151cd46b4a148a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a91d2af97d7b6a7a5a75234a43d6f4369"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classLoyc_1_1Threading_1_1ThreadLocalVariable_3_01T_01_4.html#a91d2af97d7b6a7a5a75234a43d6f4369">ThreadLocalVariable</a> (T initialValue, T fallbackValue, Func&lt; T, T &gt; propagator)</td></tr>
<tr class="memdesc:a91d2af97d7b6a7a5a75234a43d6f4369"><td class="mdescLeft">&#160;</td><td class="mdescRight">Constructs a ThreadLocalVariable. <a href="#a91d2af97d7b6a7a5a75234a43d6f4369">More...</a><br /></td></tr>
<tr class="separator:a91d2af97d7b6a7a5a75234a43d6f4369"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pro-attribs"></a>
Protected fields</h2></td></tr>
<tr class="memitem:ae5e80b137bb379a3b9af813ae03bc9d9"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae5e80b137bb379a3b9af813ae03bc9d9"></a>
Dictionary&lt; int, T &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>_tls</b> = new Dictionary&lt;int,T&gt;(5)</td></tr>
<tr class="separator:ae5e80b137bb379a3b9af813ae03bc9d9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a94c6fbe130a7e15ded5e55d9bea52930"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a94c6fbe130a7e15ded5e55d9bea52930"></a>
<a class="el" href="structLoyc_1_1Threading_1_1TinyReaderWriterLock.html">TinyReaderWriterLock</a>&#160;</td><td class="memItemRight" valign="bottom"><b>_lock</b> = TinyReaderWriterLock.New</td></tr>
<tr class="separator:a94c6fbe130a7e15ded5e55d9bea52930"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1bb38374737fe341e80d3530a758279b"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1bb38374737fe341e80d3530a758279b"></a>
Func&lt; T, T &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>_propagator</b> = delegate(T v) { return v; }</td></tr>
<tr class="separator:a1bb38374737fe341e80d3530a758279b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2dfe8ab920494e800a2fca607768c7b5"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a2dfe8ab920494e800a2fca607768c7b5"></a>
T&#160;</td><td class="memItemRight" valign="bottom"><b>_fallbackValue</b></td></tr>
<tr class="separator:a2dfe8ab920494e800a2fca607768c7b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="aa940e51dd31efe3dfe151cd46b4a148a"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Loyc.Threading.ThreadLocalVariable&lt; T &gt;.ThreadLocalVariable </td>
          <td>(</td>
          <td class="paramtype">T&#160;</td>
          <td class="paramname"><em>initialValue</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Constructs a ThreadLocalVariable.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">initialValue</td><td>Initial value on the current thread; also used as the FallbackValue in threads that are not created via <a class="el" href="classLoyc_1_1Threading_1_1ThreadEx.html" title="Creates and controls a thread, and fills in a gap in the .NET framework by propagating thread-local v...">ThreadEx</a> and in other threads that are already running.</td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a91d2af97d7b6a7a5a75234a43d6f4369"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">Loyc.Threading.ThreadLocalVariable&lt; T &gt;.ThreadLocalVariable </td>
          <td>(</td>
          <td class="paramtype">T&#160;</td>
          <td class="paramname"><em>initialValue</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">T&#160;</td>
          <td class="paramname"><em>fallbackValue</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Func&lt; T, T &gt;&#160;</td>
          <td class="paramname"><em>propagator</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Constructs a ThreadLocalVariable.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">initialValue</td><td>Initial value on the current thread. Does not affect other threads that are already running.</td></tr>
    <tr><td class="paramname">fallbackValue</td><td>Value to use when a given thread doesn't have an associated value.</td></tr>
    <tr><td class="paramname">propagator</td><td>A function that copies (and possibly modifies) the Value from a parent thread when starting a new thread.</td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Property Documentation</h2>
<a class="anchor" id="a6c1e736aae51e5b1dc50d4fbde1b650f"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">T Loyc.Threading.ThreadLocalVariable&lt; T &gt;.FallbackValue</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">get</span><span class="mlabel">set</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>When a thread is not created using <a class="el" href="classLoyc_1_1Threading_1_1ThreadEx.html" title="Creates and controls a thread, and fills in a gap in the .NET framework by propagating thread-local v...">ThreadEx</a>, the value of your ThreadLocalVariable fails to propagate from the parent thread to the child thread. In that case, Value takes on the value of FallbackValue the first time it is called. </p>
<p>By default, the FallbackValue is the initialValue passed to the constructor. </p>

</div>
</div>
<a class="anchor" id="aa9a110d48f2270d2981c74669795f437"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">T Loyc.Threading.ThreadLocalVariable&lt; T &gt;.Value</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">get</span><span class="mlabel">set</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Value of the thread-local variable.</p>
<p>This property returns FallbackValue if no value exists for this thread. </p>

</div>
</div>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Mar 24 2016 09:22:27 for Enhanced C# by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.7
</small></address>
</body>
</html>
